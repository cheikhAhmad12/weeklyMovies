docker compose run --rm etl bash -lc 'python - << "PY"
import os, requests, psycopg
TEI=os.getenv("TEI_URL","http://tei:80")
TGI=os.getenv("TGI_URL","http://tgi:80")

texte="Un film très drôle et touchant, avec un rythme parfait."
# résumé/sentiment (minimal, on prend la sortie brute)
gen = requests.post(
    f"{TGI}/generate",
    json={
        "inputs": f"1) Résume en 1 phrase 2) Sentiment (positif/neutre/négatif) pour: {texte}",
        "parameters": {"max_new_tokens": 60, "temperature": 0.2},
    },
).json().get("generated_text","")

# embedding
emb = requests.post(f"{TEI}/embed", json={"inputs":[texte]}).json()[0]

with psycopg.connect("dbname=movies user=etl password=etl host=postgres port=5432") as conn:
    with conn.cursor() as cur:
        # ✅ paramètre = zéro problème de quotes
        cur.execute(
            "INSERT INTO dim_source(nom) VALUES (%s) ON CONFLICT (nom) DO NOTHING;",
            ("SensCritique",),
        )

        cur.execute("""
            INSERT INTO dim_film(titre, senscritique_url)
            VALUES (%s, %s)
            ON CONFLICT (senscritique_url) DO NOTHING
            RETURNING film_id
        """, ("Film de test","https://exemple/film-test"))

        row = cur.fetchone()
        if row:
            film_id = row[0]
        else:
            cur.execute(
                "SELECT film_id FROM dim_film WHERE senscritique_url=%s",
                ("https://exemple/film-test",),
            )
            film_id = cur.fetchone()[0]

        cur.execute(
            "SELECT source_id FROM dim_source WHERE nom=%s",
            ("SensCritique",),
        )
        source_id = cur.fetchone()[0]

        cur.execute("""
        INSERT INTO fact_critique(
            film_id, source_id, auteur, date_publication, note_numeric,
            texte, resume_llm, sentiment_label, themes, embedding, url, hash_critique
        )
        VALUES (%s,%s,%s,NOW(),%s,%s,%s,%s,%s,%s,%s,%s)
        ON CONFLICT (hash_critique) DO NOTHING
        """, (
            film_id,
            source_id,
            "bot",
            8.5,
            texte,
            gen,
            "positif",
            ["humour","émotion"],
            emb,
            "http://exemple",
            "hash-test-1",
        ))
        conn.commit()
        print("✅ Insert OK")
PY'
